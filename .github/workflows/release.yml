name: Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    PYTHON_DEFAULT: "3.12"
    UV_CACHE_DIR: ~/.cache/uv

jobs:
    # ---------------------------------------------------------------
    # 1. Build & validate distribution artifacts (artifact-level gates)
    # ---------------------------------------------------------------
    build:
        name: Build & validate package artifacts
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_DEFAULT }}

            - name: Install uv
              uses: astral-sh/setup-uv@v2

            - name: Cache uv env
              uses: actions/cache@v4
              with:
                  path: |
                      .venv
                      ~/.cache/uv
                  key: release-${{ runner.os }}-py${{ env.PYTHON_DEFAULT }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
                  restore-keys: |
                      release-${{ runner.os }}-py${{ env.PYTHON_DEFAULT }}-

            - name: Sync dependencies (dev extra)
              run: uv sync --extra dev

            # Optional: ultra-fast source-level smoke
            # - name: Smoke tests (fast)
            #   run: make test.smoke

            - name: Build distributions (sdist + wheel)
              run: make package.build

            - name: Check distributions (twine check)
              run: make package.check

            - name: Install-test built wheel (artifact-level smoke)
              run: make package.install-test

            - name: Upload dist artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
                  if-no-files-found: error

    # ---------------------------------------------------------------
    # 2. Attest build provenance for dist/*
    # ---------------------------------------------------------------
    attest:
        name: Attest build provenance
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
            attestations: write

        steps:
            - name: Download dist artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Generate build provenance attestation
              uses: actions/attest-build-provenance@v1
              with:
                  subject-path: "dist/*"

    # ---------------------------------------------------------------
    # 3. Publish to PyPI via Trusted Publisher
    # ---------------------------------------------------------------
    publish-pypi:
        name: Publish to PyPI (Trusted Publisher)
        needs:
            - build
            - attest
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write # REQUIRED for OIDC / Trusted Publisher

        steps:
            - name: Download dist artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Publish package distributions to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/

    # ---------------------------------------------------------------
    # 4. Create GitHub Release with attached dists
    # ---------------------------------------------------------------
    github-release:
        name: GitHub Release
        needs:
            - build
            - attest
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Download dist artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/*
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
