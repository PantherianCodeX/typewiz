name: Nightly

on:
    schedule:
        - cron: "0 5 * * *" # daily at 05:00 UTC (adjust to taste)
    workflow_dispatch:

concurrency:
    group: nightly-${{ github.workflow }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    PYTHON_DEFAULT: "3.12"
    UV_CACHE_DIR: ~/.cache/uv

jobs:
    full-tests:
        name: Nightly tests â€“ py${{ matrix.python-version }} / ${{ matrix.task }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.10", "3.11", "3.12", "3.13"]
                task: [unit, integration, property, performance]

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - uses: astral-sh/setup-uv@v2

            - name: Cache uv env & pytest cache
              uses: actions/cache@v4
              with:
                  path: |
                      .venv
                      ~/.cache/uv
                      .pytest_cache
                  key: nightly-${{ runner.os }}-tests-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
                  restore-keys: |
                      nightly-${{ runner.os }}-tests-py${{ matrix.python-version }}-

            - name: Sync dependencies (dev extra)
              run: uv sync --extra dev

            - name: Run tests
              run: |
                  case "${{ matrix.task }}" in
                    unit)        make test.unit ;;
                    integration) make test.integration ;;
                    property)    make test.property ;;
                    performance) make test.performance ;;
                  esac

    full-ci-checks:
        name: Nightly full CI checks (ci.check)
        runs-on: ubuntu-latest
        needs: full-tests

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - uses: astral-sh/setup-uv@v2

            - name: Cache uv env & tools
              uses: actions/cache@v4
              with:
                  path: |
                      .venv
                      ~/.cache/uv
                      .ruff_cache
                      .mypy_cache
                      .pyrightcache
                      .pytest_cache
                  key: nightly-${{ runner.os }}-ci-check-${{ hashFiles('pyproject.toml', 'uv.lock') }}
                  restore-keys: |
                      nightly-${{ runner.os }}-ci-check-

            - name: Sync dependencies (dev extra)
              run: uv sync --extra dev

            - name: Run full CI parity check (ratchetr + lint + type + tests + sec + checks)
              run: make ci.check

    ratchetr-nightly:
        name: Ratchetr dashboards & readiness
        runs-on: ubuntu-latest
        needs: full-ci-checks
        env:
            RATCHETR_LIMIT: 100

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - uses: astral-sh/setup-uv@v2

            - name: Cache uv env & ratchetr caches
              uses: actions/cache@v4
              with:
                  path: |
                      .venv
                      ~/.cache/uv
                      .ruff_cache
                      .mypy_cache
                      .pyrightcache
                  key: nightly-${{ runner.os }}-ratchetr-${{ hashFiles('pyproject.toml', 'uv.lock') }}
                  restore-keys: |
                      nightly-${{ runner.os }}-ratchetr-

            - name: Sync dependencies (dev extra)
              run: uv sync --extra dev

            - name: Nightly ratchetr all (audit + dashboards + readiness)
              run: make all.ratchetr

            - name: Upload ratchetr artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: ratchetr-nightly
                  path: |
                      out/ratchetr
                      out/security
                  if-no-files-found: ignore
