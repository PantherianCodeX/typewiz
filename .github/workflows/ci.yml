name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PYTHON_DEFAULT: "3.12"
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  # ---------------------------------------------------------------
  # 1. Lint + types + internal + security (single Python)
  # ---------------------------------------------------------------
  quality:
    name: Quality (lint + types + internal + security)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - uses: astral-sh/setup-uv@v2

      - name: Cache uv env & tooling
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
            .ruff_cache
            .mypy_cache
            .pyrightcache
          key: ${{ runner.os }}-quality-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-quality-py${{ matrix.python-version }}-

      - name: Sync dependencies (dev extra)
        run: uv sync --extra dev

      - name: Lint (ruff, format, pylint, markdown)
        run: make all.lint

      - name: Typing (mypy + pyright + verifytypes)
        run: make all.type

      - name: Internal checks (error codes + license headers + ignore justifications)
        run: make all.check

      - name: Security checks (ruff S, Bandit, Safety)
        env:
          SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
        run: make all.sec

  # ---------------------------------------------------------------
  # 2. Core tests: unit + integration on all supported Pythons
  # ---------------------------------------------------------------
  tests:
    name: Tests (Linux) â€“ py${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - uses: astral-sh/setup-uv@v2

      - name: Cache uv env & pytest cache
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
            .pytest_cache
          key: ${{ runner.os }}-tests-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-tests-py${{ matrix.python-version }}-

      - name: Sync dependencies (dev extra)
        run: uv sync --extra dev

      - name: Unit tests
        run: make test.unit

      - name: Integration tests
        run: make test.integration

  # ---------------------------------------------------------------
  # 3. Coverage on default Python (95% gate)
  # ---------------------------------------------------------------
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT }}

      - uses: astral-sh/setup-uv@v2

      - name: Cache uv env & pytest cache
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
            .pytest_cache
          key: ${{ runner.os }}-cov-py${{ env.PYTHON_DEFAULT }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-cov-py${{ env.PYTHON_DEFAULT }}-

      - name: Sync dependencies (dev extra)
        run: uv sync --extra dev

      - name: Tests with coverage (95% gate)
        run: make test.cov
